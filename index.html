<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Meu Apto Ideal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669', /* Verde Esmeralda/Teal */
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS (Mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- SweetAlert2 para Alertas Bonitos -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Mapa e Elementos de Interface */
        #map { height: 600px; width: 100%; z-index: 10; border-radius: 0.5rem; }
        @media (max-width: 768px) {
            #map { height: calc(100vh - 220px); min-height: 400px; } 
        }
        
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Ajustes Leaflet Popup */
        .custom-leaflet-popup .leaflet-popup-content-wrapper { padding: 0 !important; overflow: hidden; border-radius: 0.75rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2); }
        .custom-leaflet-popup .leaflet-popup-content { margin: 0 !important; width: 280px !important; }
        @media (min-width: 768px) { .custom-leaflet-popup .leaflet-popup-content { width: 320px !important; } }
        .custom-leaflet-popup .leaflet-popup-close-button { color: white !important; background: rgba(0,0,0,0.4) !important; border-radius: 50%; width: 24px !important; height: 24px !important; text-align: center; line-height: 24px !important; right: 10px !important; top: 10px !important; z-index: 20; text-decoration: none; font-weight: bold; font-family: sans-serif; transition: background 0.3s; padding: 0 !important;}
        .custom-leaflet-popup .leaflet-popup-close-button:hover { background: rgba(0,0,0,0.7) !important; }
        
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; padding-right: 2.5rem !important; }
        
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .overflow-x-auto { -webkit-overflow-scrolling: touch; }

        /* Kanban Columns drag visual */
        .kanban-col.drag-over { background-color: #f1f5f9; border-color: #10b981; border-style: dashed; }
        .kanban-card { cursor: grab; }
        .kanban-card:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col pb-20 md:pb-0">

    <!-- Navbar Superior -->
    <nav class="bg-brand-700 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16 w-full">
                <!-- Esquerda: Logo e Título -->
                <div class="flex items-center cursor-pointer md:mr-8 shrink-0" onclick="app.navigate('list')">
                    <i class="fa-solid fa-building text-2xl mr-2 text-brand-200"></i>
                    <span class="font-bold text-xl tracking-tight">Meu Apto Ideal</span>
                </div>
                
                <!-- Centro/Direita: Desktop Menu -->
                <div class="hidden md:flex items-center space-x-1 shrink-0" id="nav-links">
                    <button onclick="app.navigate('list')" class="nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-brand-600 transition" data-target="list">
                        <i class="fa-solid fa-list mr-1"></i> Lista
                    </button>
                    <button onclick="app.navigate('kanban')" class="nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-brand-600 transition" data-target="kanban">
                        <i class="fa-solid fa-table-columns mr-1"></i> Kanban
                    </button>
                    <button onclick="app.navigate('map')" class="nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-brand-600 transition" data-target="map">
                        <i class="fa-solid fa-map-location-dot mr-1"></i> Mapa
                    </button>
                    <button onclick="app.navigate('favorites')" class="nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-brand-600 transition" data-target="favorites">
                        <i class="fa-solid fa-heart mr-1"></i> Favoritos
                    </button>
                    <button onclick="app.navigate('form')" class="ml-4 bg-brand-500 hover:bg-brand-400 text-white px-4 py-2 rounded-md text-sm font-bold shadow transition">
                        <i class="fa-solid fa-plus mr-1"></i> Adicionar
                    </button>
                </div>

                <!-- Direita: Mobile Favoritos -->
                <div class="md:hidden shrink-0 flex items-center pr-1">
                    <button onclick="app.navigate('favorites')" class="text-brand-100 hover:text-white p-2 transition-colors nav-btn-mobile relative" data-target="favorites">
                        <i class="fa-solid fa-heart text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Bottom Navigation (Mobile Only) - Apenas 4 botões e 1 invisível p/ balancear o "+" no centro -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-16 z-50 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] px-1">
        <button onclick="app.navigate('list')" class="nav-btn-mobile flex-1 flex flex-col items-center justify-center text-slate-500 hover:text-brand-600 h-full transition-colors" data-target="list">
            <i class="fa-solid fa-list text-lg mb-1"></i><span class="text-[10px] font-medium">Lista</span>
        </button>
        <button onclick="app.navigate('kanban')" class="nav-btn-mobile flex-1 flex flex-col items-center justify-center text-slate-500 hover:text-brand-600 h-full transition-colors" data-target="kanban">
            <i class="fa-solid fa-table-columns text-lg mb-1"></i><span class="text-[10px] font-medium">Funil</span>
        </button>
        
        <!-- Botão Adicionar Flutuante -->
        <button onclick="app.navigate('form')" class="nav-btn-mobile relative flex-[1.2] flex flex-col items-center justify-center h-full group" data-target="form">
            <div class="absolute -top-6 bg-brand-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-[4px] border-slate-50 group-hover:scale-105 transition-transform duration-200">
                <i class="fa-solid fa-plus text-2xl"></i>
            </div>
            <span class="text-[10px] mt-8 text-brand-600 font-bold opacity-0 transition-opacity">Novo</span>
        </button>
        
        <button onclick="app.navigate('map')" class="nav-btn-mobile flex-1 flex flex-col items-center justify-center text-slate-500 hover:text-brand-600 h-full transition-colors" data-target="map">
            <i class="fa-solid fa-map-location-dot text-lg mb-1"></i><span class="text-[10px] font-medium">Mapa</span>
        </button>
        
        <!-- Placeholder fantasma para balancear espaço já que são 4 itens visíveis e o flutuante precisa parecer centralizado visualmente. -->
        <div class="flex-1"></div> 
    </div>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8 w-full" id="main-content">
        <!-- Views serão injetadas aqui pelo JS -->
    </main>

    <!-- Modal de Detalhes -->
    <div id="apt-modal" class="fixed inset-0 bg-slate-900/70 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity overflow-hidden" onclick="app.closeModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto overflow-x-hidden flex flex-col relative animate-fade-in-up custom-scrollbar" onclick="event.stopPropagation()">
            <div id="modal-content-inject"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Application Logic -->
    <script>
        const supabaseUrl = 'https://ydazjbnolrsheicyefmh.supabase.co'; 
        const supabaseKey = 'sb_publishable_uftOQnToDUBrydtMrIAt7w_WvvwfXu1';
        
        let supabaseClient = null;
        try {
            supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        } catch (error) {
            console.warn("Supabase URL inválida. O aplicativo rodará em modo local.");
        }

        const STATUS_OPTIONS = ['Novo', 'Visita Agendada', 'Visitado', 'Proposta', 'Descartado'];

        const app = {
            state: {
                view: 'list',
                apartments: [],
                filters: { searchTitle: '', neighborhood: '', building: '' },
                sortBy: 'dateDesc',
                editingId: null,
                mapInstance: null,
                draggingAptId: null,
                tempDragLatLng: null,
                clusters: {},
                statuses: ['Novo', 'Visita Agendada', 'Visitado', 'Proposta', 'Descartado']
            },

            async init() {
                await this.loadData();
                this.navigate('list');
            },

            async loadData() {
                Swal.fire({ title: 'Carregando...', text: 'Buscando dados no banco na nuvem', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                try {
                    if (!supabaseClient) throw new Error("Cliente Supabase não inicializado.");
                    
                    const { data, error } = await supabaseClient
                        .from('apartments')
                        .select('*')
                        .order('dateAdded', { ascending: false });
                        
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        this.state.apartments = data.map(a => ({...a, status: a.status || 'Novo'}));
                    } else {
                        this.state.apartments = this.getSampleData();
                    }
                } catch (err) {
                    console.error("Erro ao carregar Supabase:", err);
                    Swal.fire({ icon: 'warning', title: 'Modo Offline', text: 'Supabase não conectado. Usando dados locais.', timer: 3000 });
                    
                    const localData = localStorage.getItem('meuAptoIdealData_v2');
                    if (localData) {
                        this.state.apartments = JSON.parse(localData).map(a => ({...a, status: a.status || 'Novo'}));
                    } else {
                        this.state.apartments = this.getSampleData();
                    }
                }
                
                Swal.close();
            },

            navigate(view) {
                if(this.state.draggingAptId && view !== 'map') {
                    Swal.fire('Ação Pendente', 'Salve ou cancele a posição do pino primeiro.', 'warning');
                    return;
                }

                this.state.view = view;
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if(btn.dataset.target === view) {
                        btn.classList.add('bg-brand-900', 'text-white');
                        btn.classList.remove('hover:bg-brand-600');
                    } else {
                        btn.classList.remove('bg-brand-900');
                        btn.classList.add('hover:bg-brand-600');
                    }
                });

                document.querySelectorAll('.nav-btn-mobile').forEach(btn => {
                    if(btn.dataset.target === view && view !== 'form') {
                        btn.classList.add('text-brand-600');
                        btn.classList.remove('text-slate-500');
                        // Para o topo (Favoritos)
                        if(btn.classList.contains('text-brand-100')) {
                            btn.classList.remove('text-brand-100');
                            btn.classList.add('text-white');
                        }
                    } else {
                        btn.classList.remove('text-brand-600');
                        btn.classList.add('text-slate-500');
                        // Para o topo (Favoritos)
                        if(btn.dataset.target === 'favorites') {
                            btn.classList.remove('text-white');
                            btn.classList.add('text-brand-100');
                        }
                    }
                });

                const content = document.getElementById('main-content');
                if (this.state.view !== 'map' && this.state.mapInstance) {
                    this.state.mapInstance.remove();
                    this.state.mapInstance = null;
                }

                switch(view) {
                    case 'list': this.renderList(content, false); break;
                    case 'favorites': this.renderList(content, true); break;
                    case 'form': this.renderForm(content); break;
                    case 'map': this.renderMap(content); break;
                    case 'kanban': this.renderKanban(content); break;
                }
                
                window.scrollTo(0,0);
            },

            // --- UTILS & ACTIONS ---
            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
            },

            renderStars(rating) {
                let html = '';
                for(let i=1; i<=5; i++) {
                    html += `<i class="fa-solid fa-star ${i <= rating ? 'text-amber-400' : 'text-slate-200'}"></i>`;
                }
                return html;
            },

            getStatusColor(status) {
                switch(status) {
                    case 'Novo': return 'bg-blue-100 text-blue-700 border-blue-200';
                    case 'Visita Agendada': return 'bg-amber-100 text-amber-700 border-amber-200';
                    case 'Visitado': return 'bg-purple-100 text-purple-700 border-purple-200';
                    case 'Proposta': return 'bg-emerald-100 text-emerald-700 border-emerald-200';
                    case 'Descartado': return 'bg-slate-200 text-slate-500 border-slate-300';
                    default: return 'bg-gray-100 text-gray-700';
                }
            },

            async toggleFavorite(id) {
                const apt = this.state.apartments.find(a => a.id === id);
                if(apt) {
                    const newFavState = !apt.favorite;
                    apt.favorite = newFavState;
                    localStorage.setItem('meuAptoIdealData_v2', JSON.stringify(this.state.apartments));

                    if(this.state.view === 'favorites') this.renderList(document.getElementById('main-content'), true);
                    else if(this.state.view === 'list') this.renderList(document.getElementById('main-content'), false);
                    else if(this.state.view === 'kanban') this.renderKanban(document.getElementById('main-content'));
                    
                    try {
                        if (supabaseClient) {
                            await supabaseClient.from('apartments').update({ favorite: newFavState }).eq('id', id);
                        }
                    } catch(err) {
                        console.error("Erro ao favoritar no banco", err);
                    }
                }
            },

            editApt(id) {
                this.state.editingId = id;
                this.navigate('form');
            },

            deleteApt(id) {
                Swal.fire({
                    title: 'Tem certeza?',
                    text: "Esta ação apagará o registro definitivamente!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#64748b',
                    confirmButtonText: 'Sim, excluir!',
                    cancelButtonText: 'Cancelar'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        Swal.fire({ title: 'Excluindo...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                        
                        try {
                            if (supabaseClient) {
                                const { error } = await supabaseClient.from('apartments').delete().eq('id', id);
                                if (error) throw error;
                            }
                        } catch(err) {
                            console.error("Erro ao excluir no Supabase", err);
                        }

                        this.state.apartments = this.state.apartments.filter(a => a.id !== id);
                        localStorage.setItem('meuAptoIdealData_v2', JSON.stringify(this.state.apartments));

                        if(this.state.view === 'favorites') this.renderList(document.getElementById('main-content'), true);
                        else if(this.state.view === 'kanban') this.renderKanban(document.getElementById('main-content'));
                        else this.renderList(document.getElementById('main-content'), false);

                        Swal.fire('Excluído!', 'O apartamento foi deletado com sucesso.', 'success');
                    }
                })
            },

            applyFilters() {
                this.state.filters = {
                    searchTitle: document.getElementById('filter-title').value,
                    neighborhood: document.getElementById('filter-neighborhood').value,
                    building: document.getElementById('filter-building').value,
                };
                this.renderList(document.getElementById('main-content'), false);
            },

            clearFilters() {
                this.state.filters = { searchTitle: '', neighborhood: '', building: '' };
                document.getElementById('filter-title').value = '';
                document.getElementById('filter-neighborhood').value = '';
                document.getElementById('filter-building').value = '';
                this.renderList(document.getElementById('main-content'), false);
            },

            // --- VIEW: LIST / FAVORITES ---
            renderList(container, onlyFavorites = false) {
                const uniqueNeighborhoods = [...new Set(this.state.apartments.map(a => a.neighborhood))].filter(Boolean).sort();
                const uniqueBuildings = [...new Set(this.state.apartments.map(a => a.building))].filter(Boolean).sort();

                let html = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-800">
                            ${onlyFavorites ? '<i class="fa-solid fa-heart text-red-500 mr-2"></i> Meus Favoritos' : 'Todos os Apartamentos'}
                        </h1>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Filters Sidebar -->
                        ${!onlyFavorites ? `
                        <aside class="w-full lg:w-1/4 bg-white rounded-xl border border-slate-200 shadow-sm h-fit p-4 md:p-5">
                            <h2 class="font-bold text-lg flex items-center mb-4"><i class="fa-solid fa-filter mr-2 text-brand-600"></i> Filtros</h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-700 mb-1">Buscar por nome</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fa-solid fa-search text-slate-400 text-sm"></i>
                                        </div>
                                        <input type="text" id="filter-title" value="${this.state.filters.searchTitle || ''}" placeholder="Palavra chave..." class="pl-9 w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-2 outline-none transition">
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-700 mb-1">Bairro</label>
                                        <select id="filter-neighborhood" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-2 outline-none transition cursor-pointer">
                                            <option value="">Todos</option>
                                            ${uniqueNeighborhoods.map(n => `<option value="${n}" ${this.state.filters.neighborhood === n ? 'selected' : ''}>${n}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-700 mb-1">Edifício</label>
                                        <select id="filter-building" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-2 outline-none transition cursor-pointer">
                                            <option value="">Todos</option>
                                            ${uniqueBuildings.map(b => `<option value="${b}" ${this.state.filters.building === b ? 'selected' : ''}>${b}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div class="flex gap-2 pt-1">
                                    <button onclick="app.applyFilters()" class="flex-1 flex justify-center items-center text-white bg-brand-600 hover:bg-brand-700 font-medium rounded-lg text-sm px-3 py-2.5 transition shadow-sm">
                                        <i class="fa-solid fa-check mr-1.5"></i> Filtrar
                                    </button>
                                    <button onclick="app.clearFilters()" class="flex-1 flex justify-center items-center text-brand-700 bg-brand-50 hover:bg-brand-100 border border-brand-200 font-medium rounded-lg text-sm px-3 py-2.5 transition">
                                        <i class="fa-solid fa-eraser mr-1.5"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </aside>
                        ` : ''}

                        <!-- Grid de Apartamentos -->
                        <div class="w-full ${!onlyFavorites ? 'lg:w-3/4' : ''}" id="apt-grid"></div>
                    </div>
                `;
                container.innerHTML = html;
                this.renderGrid(onlyFavorites);
            },

            renderGrid(onlyFavorites) {
                const grid = document.getElementById('apt-grid');
                let filtered = this.state.apartments;

                if (onlyFavorites) {
                    filtered = filtered.filter(a => a.favorite);
                } else {
                    const { searchTitle, neighborhood, building } = this.state.filters;
                    if (searchTitle) filtered = filtered.filter(a => a.title.toLowerCase().includes(searchTitle.toLowerCase()));
                    if (neighborhood) filtered = filtered.filter(a => a.neighborhood === neighborhood);
                    if (building) filtered = filtered.filter(a => a.building === building);
                }

                filtered.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded)); 

                if (filtered.length === 0) {
                    grid.innerHTML = `
                        <div class="bg-white rounded-xl border border-slate-200 p-8 md:p-12 text-center flex flex-col items-center justify-center h-full shadow-sm">
                            <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fa-regular fa-folder-open text-4xl text-slate-400"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-700">Nenhum apartamento encontrado</h3>
                            <p class="text-slate-500 mt-2 max-w-md">Tente ajustar os filtros ou adicione novas opções ao seu catálogo.</p>
                            ${!onlyFavorites ? `<button onclick="app.navigate('form')" class="mt-6 bg-brand-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-brand-700 transition shadow">Adicionar Novo Imóvel</button>` : ''}
                        </div>
                    `;
                    return;
                }

                let cardsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">`;
                
                filtered.forEach(apt => {
                    const statusClass = this.getStatusColor(apt.status);
                    const isDiscarded = apt.status === 'Descartado';
                    const discardedStyles = isDiscarded ? 'opacity-50 grayscale hover:opacity-75 bg-slate-50' : 'bg-white';
                    
                    cardsHtml += `
                        <div class="rounded-xl border border-slate-200 shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden flex flex-col relative group cursor-pointer ${discardedStyles}" onclick="app.viewApt('${apt.id}')">
                            <div class="h-44 md:h-48 bg-slate-200 relative overflow-hidden">
                                <img src="${apt.photo || 'https://via.placeholder.com/400x300?text=Sem+Foto'}" alt="${apt.title}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                                
                                <button onclick="event.stopPropagation(); app.toggleFavorite('${apt.id}')" class="absolute top-3 right-3 h-10 w-10 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-xl shadow-sm active:scale-95 md:hover:scale-110 md:hover:bg-white transition text-${apt.favorite ? 'red-500' : 'slate-400'}">
                                    <i class="fa-${apt.favorite ? 'solid' : 'regular'} fa-heart"></i>
                                </button>
                                <div class="absolute top-3 left-3 px-2.5 py-1 rounded-md text-xs font-bold shadow-sm border ${statusClass}">
                                    ${apt.status || 'Novo'}
                                </div>
                                <div class="absolute bottom-3 left-3 bg-brand-600/95 backdrop-blur text-white px-3 py-1.5 rounded-lg text-sm md:text-base font-bold shadow-lg border border-white/20">
                                    ${this.formatCurrency(apt.price)}
                                </div>
                            </div>

                            <div class="p-4 md:p-5 flex-grow flex flex-col">
                                <h3 class="font-bold text-lg text-slate-800 line-clamp-2 leading-tight mb-2" title="${apt.title}">${apt.title}</h3>
                                ${apt.building ? `<p class="text-sm text-brand-700 font-semibold mb-1"><i class="fa-regular fa-building mr-1"></i> ${apt.building}</p>` : ''}
                                <p class="text-sm text-slate-500 mb-3 flex items-center"><i class="fa-solid fa-location-dot w-4 text-center mr-1 text-slate-400"></i> ${apt.neighborhood}, ${apt.city}</p>
                                
                                <div class="flex gap-2 mb-3">
                                    ${apt.floor ? `<span class="bg-slate-100 text-slate-600 text-[10px] px-2 py-1 rounded font-medium"><i class="fa-solid fa-stairs mr-1"></i> ${apt.floor}</span>` : ''}
                                    ${apt.sunOrientation ? `<span class="bg-amber-50 text-amber-700 text-[10px] px-2 py-1 rounded font-medium"><i class="fa-regular fa-sun mr-1"></i> Sol: ${apt.sunOrientation}</span>` : ''}
                                </div>

                                <div class="grid grid-cols-3 gap-2 mb-4 border-y border-slate-100 py-3 bg-slate-50/50 rounded-lg">
                                    <div class="text-center">
                                        <div class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1">Área</div>
                                        <div class="font-bold text-slate-700 text-sm md:text-base"><i class="fa-solid fa-ruler-combined text-slate-400 mr-1"></i>${apt.area}m²</div>
                                    </div>
                                    <div class="text-center border-l border-r border-slate-200">
                                        <div class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1">Quartos</div>
                                        <div class="font-bold text-slate-700 text-sm md:text-base"><i class="fa-solid fa-bed text-slate-400 mr-1"></i>${apt.bedrooms}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-[10px] text-brand-600 uppercase font-bold tracking-wider mb-1">R$/m²</div>
                                        <div class="font-bold text-brand-700 text-sm md:text-base">${this.formatCurrency(apt.priceM2).replace(',00', '')}</div>
                                    </div>
                                </div>

                                <div class="mt-auto pt-1">
                                    <div class="flex justify-end items-center border-t border-slate-100 pt-3">
                                        <div class="flex space-x-1.5">
                                            <a href="${apt.link}" target="_blank" onclick="event.stopPropagation()" class="w-9 h-9 rounded-md bg-slate-100 flex items-center justify-center text-slate-600 active:bg-brand-100 md:hover:bg-brand-100 active:text-brand-700 md:hover:text-brand-700 transition" title="Ver Anúncio">
                                                <i class="fa-solid fa-arrow-up-right-from-square text-sm"></i>
                                            </a>
                                            <button onclick="event.stopPropagation(); app.editApt('${apt.id}')" class="w-9 h-9 rounded-md bg-slate-100 flex items-center justify-center text-slate-600 active:bg-amber-100 md:hover:bg-amber-100 active:text-amber-700 md:hover:text-amber-700 transition" title="Editar">
                                                <i class="fa-solid fa-pen text-sm"></i>
                                            </button>
                                            <button onclick="event.stopPropagation(); app.deleteApt('${apt.id}')" class="w-9 h-9 rounded-md bg-slate-100 flex items-center justify-center text-slate-600 active:bg-red-100 md:hover:bg-red-100 active:text-red-700 md:hover:text-red-700 transition" title="Excluir">
                                                <i class="fa-solid fa-trash text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                cardsHtml += `</div>`;
                grid.innerHTML = cardsHtml;
            },

            // --- VIEW: KANBAN ---
            renderKanban(container) {
                let html = `
                    <div class="mb-4">
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-800"><i class="fa-solid fa-table-columns text-brand-600 mr-2"></i> Funil de Decisão</h1>
                        <p class="text-slate-500 mt-1 text-sm">Acompanhe e mova seus apartamentos pelo processo de escolha.</p>
                    </div>
                    
                    <div class="flex overflow-x-auto gap-4 pb-4 snap-x custom-scrollbar min-h-[60vh]">
                `;

                this.state.statuses.forEach(status => {
                    const aptsInStatus = this.state.apartments.filter(a => (a.status || 'Novo') === status);
                    
                    html += `
                        <div class="kanban-col flex-shrink-0 w-72 md:w-80 bg-slate-100/50 rounded-xl p-3 border-2 border-transparent transition-colors flex flex-col snap-center" 
                             ondragover="app.allowDrop(event)" 
                             ondrop="app.dropOnKanban(event, '${status}')"
                             ondragenter="this.classList.add('drag-over')"
                             ondragleave="this.classList.remove('drag-over')">
                             
                            <div class="flex justify-between items-center mb-3 px-1">
                                <h3 class="font-bold text-slate-700">${status}</h3>
                                <span class="bg-white text-slate-500 text-xs px-2 py-0.5 rounded-full shadow-sm font-bold">${aptsInStatus.length}</span>
                            </div>
                            
                            <div class="flex-grow space-y-3 overflow-y-auto custom-scrollbar" id="col-${status.replace(/\s+/g, '-')}">
                    `;

                    aptsInStatus.forEach(apt => {
                        const isDiscarded = status === 'Descartado';
                        const discardedStyles = isDiscarded ? 'opacity-50 grayscale hover:opacity-75 bg-slate-50' : 'bg-white hover:border-brand-300';
                        
                        html += `
                            <div class="kanban-card p-3 rounded-lg shadow-sm border border-slate-200 hover:shadow-md transition active:scale-[0.98] ${discardedStyles}" 
                                 draggable="true" 
                                 ondragstart="app.dragStart(event, '${apt.id}')"
                                 onclick="app.viewApt('${apt.id}')">
                                <img src="${apt.photo || 'https://via.placeholder.com/200x150'}" class="w-full h-24 object-cover rounded-md mb-2 pointer-events-none">
                                <h4 class="font-bold text-sm text-slate-800 leading-tight mb-1 truncate pointer-events-none">${apt.title}</h4>
                                <div class="flex justify-between items-center pointer-events-none">
                                    <span class="text-brand-600 font-bold text-sm">${this.formatCurrency(apt.price)}</span>
                                    <span class="text-xs text-slate-500">${apt.neighborhood}</span>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                container.innerHTML = html;
            },

            // --- KANBAN LOGIC ---
            dragStart(ev, id) {
                ev.dataTransfer.setData("aptId", id);
                ev.target.style.opacity = "0.5";
            },
            allowDrop(ev) {
                ev.preventDefault(); 
            },
            async dropOnKanban(ev, newStatus) {
                ev.preventDefault();
                const targetCol = ev.currentTarget;
                targetCol.classList.remove('drag-over');
                
                const id = ev.dataTransfer.getData("aptId");
                const apt = this.state.apartments.find(a => a.id === id);
                
                if (apt && apt.status !== newStatus) {
                    apt.status = newStatus;
                    this.renderKanban(document.getElementById('main-content')); 
                    
                    localStorage.setItem('meuAptoIdealData_v2', JSON.stringify(this.state.apartments));
                    try {
                        if (supabaseClient) {
                            await supabaseClient.from('apartments').update({ status: newStatus }).eq('id', id);
                        }
                    } catch(e) { console.error("Erro ao atualizar status", e); }
                }
            },

            // --- VIEW: MODAL DETALHES ---
            viewApt(id) {
                const apt = this.state.apartments.find(a => a.id === id);
                if (!apt) return;

                const avgRating = ((parseInt(apt.ratingPrice||3) + parseInt(apt.ratingLocation||3) + parseInt(apt.ratingDeco||3))/3).toFixed(1);
                const statusClass = this.getStatusColor(apt.status);

                document.getElementById('modal-content-inject').innerHTML = `
                    <div class="h-48 md:h-64 w-full relative bg-slate-200 shrink-0">
                        <img src="${apt.photo || 'https://via.placeholder.com/800x600?text=Sem+Foto'}" class="w-full h-full object-cover" alt="Foto">
                        
                        <div class="absolute top-3 left-3">
                            <span class="${statusClass} text-xs px-3 py-1.5 rounded-lg font-bold shadow-md border uppercase tracking-wide">${apt.status || 'Novo'}</span>
                        </div>

                        <button onclick="app.closeModal(event)" class="absolute top-4 right-4 bg-white/90 backdrop-blur w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-slate-800 hover:bg-white shadow-lg transition z-10">
                            <i class="fa-solid fa-xmark text-lg md:text-xl"></i>
                        </button>
                        
                        <div class="absolute bottom-4 left-4 right-4 flex flex-col md:flex-row gap-2 items-start md:items-end pointer-events-none">
                            <div class="bg-brand-600 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg font-bold shadow-lg text-base md:text-lg border border-white/20 pointer-events-auto">
                                ${this.formatCurrency(apt.price)}
                            </div>
                            <div class="bg-white/95 backdrop-blur text-slate-800 px-2 py-1 md:px-3 md:py-1.5 rounded-lg font-bold shadow-lg text-xs md:text-sm border border-slate-200 pointer-events-auto">
                                ${this.formatCurrency(apt.priceM2).replace(',00', '')}/m²
                            </div>
                        </div>
                    </div>

                    <div class="p-4 md:p-6 flex-grow">
                        <h2 class="text-lg md:text-xl font-bold text-slate-800 leading-tight mb-2">${apt.title}</h2>
                        ${apt.building ? `<p class="text-brand-700 font-semibold mb-2 text-sm"><i class="fa-regular fa-building mr-1"></i> Edifício: ${apt.building}</p>` : ''}
                        <p class="text-slate-500 mb-5 text-xs md:text-sm"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i> ${apt.address ? apt.address + ' - ' : ''}${apt.neighborhood}, ${apt.city}</p>

                        <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 md:gap-3 mb-6">
                            <div class="col-span-1 bg-slate-50 p-2 rounded-xl border border-slate-100 flex flex-col items-center text-center justify-center"><p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Área Útil</p><p class="font-bold text-slate-800 text-sm"><i class="fa-solid fa-ruler text-brand-500 mr-1 opacity-70"></i>${apt.area}m²</p></div>
                            <div class="col-span-1 bg-slate-50 p-2 rounded-xl border border-slate-100 flex flex-col items-center text-center justify-center"><p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Quartos</p><p class="font-bold text-slate-800 text-sm"><i class="fa-solid fa-bed text-brand-500 mr-1 opacity-70"></i>${apt.bedrooms}</p></div>
                            <div class="col-span-1 bg-slate-50 p-2 rounded-xl border border-slate-100 flex flex-col items-center text-center justify-center"><p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Andar</p><p class="font-bold text-slate-800 text-sm"><i class="fa-solid fa-layer-group text-brand-500 mr-1 opacity-70"></i>${apt.floor || '-'}</p></div>
                            <div class="col-span-1 bg-slate-50 p-2 rounded-xl border border-slate-100 flex flex-col items-center text-center justify-center"><p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Sol</p><p class="font-bold text-slate-800 text-xs md:text-sm"><i class="fa-solid fa-sun text-amber-500 mr-1 opacity-70"></i>${apt.sunOrientation || '-'}</p></div>
                            <div class="col-span-1 bg-slate-50 p-2 rounded-xl border border-slate-100 flex flex-col items-center text-center justify-center"><p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Condomínio</p><p class="font-bold text-slate-800 text-xs">${this.formatCurrency(apt.condo)}</p></div>
                            <div class="col-span-1 bg-slate-50 p-2 rounded-xl border border-slate-100 flex flex-col items-center text-center justify-center"><p class="text-[9px] text-slate-500 uppercase font-bold mb-1">IPTU/Ano</p><p class="font-bold text-slate-800 text-xs">${this.formatCurrency(apt.iptu)}</p></div>
                        </div>

                        <!-- Walk Score / POIs -->
                        <div class="mb-6 bg-blue-50/50 p-3 md:p-4 rounded-xl border border-blue-100">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-blue-900 text-sm"><i class="fa-solid fa-person-walking text-blue-600 mr-1.5"></i> Radar de Comodidades (1km)</h3>
                                <button onclick="app.loadPOIs(${apt.lat}, ${apt.lng})" class="text-[10px] md:text-xs bg-white text-blue-700 border border-blue-200 px-2 py-1 rounded-lg font-bold hover:bg-blue-50 transition shadow-sm" id="btn-load-pois">Explorar Radar</button>
                            </div>
                            <p class="text-xs text-blue-600/70 mb-2 leading-tight">Consulta em tempo real mercados, farmácias, ginásios e parques no raio de 1.000m.</p>
                            <div id="poi-container" class="hidden grid-cols-2 sm:grid-cols-4 gap-2"></div>
                        </div>

                        <div class="mb-6">
                            <h3 class="font-bold text-slate-800 text-sm md:text-base mb-2 border-b border-slate-100 pb-1.5 flex items-center">
                                <i class="fa-solid fa-star-half-stroke text-amber-500 mr-1.5"></i> Notas Pessoais (Média: ${avgRating})
                            </h3>
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 text-xs md:text-sm text-slate-600">
                                <div class="flex items-center bg-white border border-slate-100 px-2 py-1.5 md:px-3 md:py-2 rounded-lg shadow-sm flex-1 justify-between">
                                    <span class="font-medium"><i class="fa-solid fa-sack-dollar mr-1 text-slate-400"></i> Preço:</span> 
                                    <div>${this.renderStars(apt.ratingPrice)}</div>
                                </div>
                                <div class="flex items-center bg-white border border-slate-100 px-2 py-1.5 md:px-3 md:py-2 rounded-lg shadow-sm flex-1 justify-between">
                                    <span class="font-medium"><i class="fa-solid fa-map-pin mr-1 text-slate-400"></i> Local:</span> 
                                    <div>${this.renderStars(apt.ratingLocation)}</div>
                                </div>
                                <div class="flex items-center bg-white border border-slate-100 px-2 py-1.5 md:px-3 md:py-2 rounded-lg shadow-sm flex-1 justify-between">
                                    <span class="font-medium"><i class="fa-solid fa-couch mr-1 text-slate-400"></i> Decor:</span> 
                                    <div>${this.renderStars(apt.ratingDeco)}</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="font-bold text-slate-800 text-sm md:text-base mb-2 border-b border-slate-100 pb-1.5"><i class="fa-solid fa-clipboard-list text-brand-500 mr-1.5"></i> Observações</h3>
                            <div class="bg-amber-50/50 p-3 rounded-xl border border-amber-100">
                                <p class="text-slate-700 text-xs md:text-sm leading-relaxed whitespace-pre-line">${apt.notes || 'Nenhuma observação informada.'}</p>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-2 pt-3 border-t border-slate-100">
                            <a href="${apt.link}" target="_blank" class="flex-1 text-center bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl shadow-md transition-colors text-sm md:text-base flex items-center justify-center">
                                Ir para Anúncio <i class="fa-solid fa-arrow-up-right-from-square ml-2"></i>
                            </a>
                            <button onclick="app.startDraggingApt('${apt.id}')" class="flex-1 text-center bg-white border-2 border-brand-200 hover:border-brand-500 text-brand-700 font-bold py-3 rounded-xl shadow-sm transition-colors text-sm md:text-base flex items-center justify-center">
                                <i class="fa-solid fa-up-down-left-right mr-2"></i> Ajustar Pino no Mapa
                            </button>
                        </div>
                    </div>
                `;

                const modal = document.getElementById('apt-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden'; 
            },

            // --- POI / WALK SCORE LOGIC (Overpass API) ---
            async loadPOIs(lat, lng) {
                if (!lat || lat === -14.235) {
                    Swal.fire('Sem Coordenadas', 'Ajuste o pino no mapa primeiro para buscar a região exata.', 'info');
                    return;
                }

                const btn = document.getElementById('btn-load-pois');
                const container = document.getElementById('poi-container');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Buscando...';
                btn.disabled = true;

                const query = `
                    [out:json][timeout:15];
                    (
                      node["shop"~"supermarket|bakery|convenience"](around:1000,${lat},${lng});
                      node["amenity"~"pharmacy|hospital|clinic"](around:1000,${lat},${lng});
                      node["amenity"~"restaurant|cafe|fast_food"](around:1000,${lat},${lng});
                      node["leisure"~"park|fitness_centre"](around:1000,${lat},${lng});
                      node["amenity"~"school|kindergarten"](around:1000,${lat},${lng});
                    );
                    out tags;
                `;
                
                try {
                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                        method: 'POST',
                        body: query
                    });
                    
                    if(!response.ok) throw new Error("Falha na API");
                    const data = await response.json();
                    
                    let counts = { mercados: 0, farmacias: 0, restaurantes: 0, saudeLazer: 0, escolas: 0 };
                    
                    data.elements.forEach(el => {
                        const tags = el.tags;
                        if(tags.shop && tags.shop.match(/supermarket|bakery|convenience/)) counts.mercados++;
                        if(tags.amenity && tags.amenity.match(/pharmacy|hospital|clinic/)) counts.farmacias++;
                        if(tags.amenity && tags.amenity.match(/restaurant|cafe|fast_food/)) counts.restaurantes++;
                        if(tags.leisure && tags.leisure.match(/park|fitness_centre/)) counts.saudeLazer++;
                        if(tags.amenity && tags.amenity.match(/school|kindergarten/)) counts.escolas++;
                    });

                    container.innerHTML = `
                        <div class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-center flex flex-col justify-center items-center">
                            <i class="fa-solid fa-cart-shopping text-blue-500 mb-1 text-lg"></i>
                            <span class="font-bold text-slate-800 text-lg leading-none">${counts.mercados}</span>
                            <span class="text-[9px] uppercase text-slate-500 font-bold mt-1">Mercados</span>
                        </div>
                        <div class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-center flex flex-col justify-center items-center">
                            <i class="fa-solid fa-pills text-red-500 mb-1 text-lg"></i>
                            <span class="font-bold text-slate-800 text-lg leading-none">${counts.farmacias}</span>
                            <span class="text-[9px] uppercase text-slate-500 font-bold mt-1">Farmácias</span>
                        </div>
                        <div class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-center flex flex-col justify-center items-center">
                            <i class="fa-solid fa-utensils text-orange-500 mb-1 text-lg"></i>
                            <span class="font-bold text-slate-800 text-lg leading-none">${counts.restaurantes}</span>
                            <span class="text-[9px] uppercase text-slate-500 font-bold mt-1">Gastronomia</span>
                        </div>
                        <div class="bg-slate-50 border border-slate-100 rounded-lg p-2 text-center flex flex-col justify-center items-center">
                            <i class="fa-solid fa-tree text-emerald-500 mb-1 text-lg"></i>
                            <span class="font-bold text-slate-800 text-lg leading-none">${counts.saudeLazer}</span>
                            <span class="text-[9px] uppercase text-slate-500 font-bold mt-1">Parques/Saúde</span>
                        </div>
                    `;
                    container.classList.remove('hidden');
                    container.classList.add('grid');
                    btn.classList.add('hidden');

                } catch(e) {
                    btn.innerHTML = 'Tentar Novamente';
                    btn.disabled = false;
                    Swal.fire('Erro', 'Serviço de mapas indisponível no momento.', 'error');
                }
            },

            closeModal(e) {
                if(e && e.target !== e.currentTarget && !e.target.closest('button')) return;
                const modal = document.getElementById('apt-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = ''; 
            },

            // --- VIEW: FORM (ADD / EDIT) ---
            renderForm(container) {
                const isEdit = this.state.editingId !== null;
                const apt = isEdit ? this.state.apartments.find(a => a.id === this.state.editingId) : {};

                let html = `
                    <div class="max-w-4xl mx-auto bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="bg-brand-50 px-4 md:px-6 py-4 border-b border-brand-100 flex justify-between items-center">
                            <h2 class="text-xl md:text-2xl font-bold text-brand-900 flex items-center">
                                <div class="w-8 h-8 rounded-full bg-brand-600 text-white flex items-center justify-center mr-3 shadow-sm"><i class="fa-solid fa-${isEdit ? 'pen' : 'plus'} text-sm"></i></div>
                                ${isEdit ? 'Editar Imóvel' : 'Cadastrar Imóvel'}
                            </h2>
                            <button onclick="app.navigate('list'); app.state.editingId = null;" class="text-slate-400 hover:text-slate-700 active:bg-slate-200 md:hover:bg-white rounded-full p-2 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                        </div>
                        
                        <form id="apt-form" class="p-4 md:p-8 space-y-8" onsubmit="event.preventDefault(); app.saveApartment();">
                            
                            <!-- SEÇÃO IA -->
                            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-xl p-5 md:p-6 flex flex-col md:flex-row items-center justify-between shadow-sm relative overflow-hidden">
                                <div class="absolute -right-4 -top-4 text-emerald-100 opacity-50 hidden md:block"><i class="fa-solid fa-robot text-9xl"></i></div>
                                <div class="relative z-10 text-center md:text-left mb-4 md:mb-0 w-full md:w-auto">
                                    <h3 class="font-bold text-emerald-900 text-lg flex items-center justify-center md:justify-start"><i class="fa-solid fa-wand-magic-sparkles text-emerald-600 mr-2"></i> Preencher com IA</h3>
                                    <p class="text-sm text-emerald-800 mt-1 max-w-lg">Cole o texto do anúncio e a IA preencherá os campos abaixo magicamente!</p>
                                </div>
                                <button type="button" onclick="app.openAIModal()" class="relative z-10 w-full md:w-auto bg-emerald-600 active:bg-emerald-700 md:hover:bg-emerald-700 text-white font-bold py-3 md:py-3 px-6 rounded-lg shadow-md transition-all md:hover:scale-105 flex items-center justify-center whitespace-nowrap">
                                    <i class="fa-solid fa-robot mr-2"></i> Usar IA Agora
                                </button>
                            </div>

                            <!-- SEÇÃO 1: DADOS BÁSICOS -->
                            <div>
                                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2 text-lg"><i class="fa-solid fa-file-lines text-brand-500 mr-2"></i> Dados do Anúncio</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                                    
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Título / Descrição Curta *</label>
                                        <input type="text" id="form-title" required value="${apt.title || ''}" placeholder="Ex: Lindo Apto 2 quartos com varanda" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>

                                    <div class="md:col-span-1">
                                        <label class="block text-sm font-medium text-slate-700 mb-1"><i class="fa-solid fa-flag text-brand-500 mr-1"></i> Estado Inicial</label>
                                        <select id="form-status" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition shadow-sm font-semibold">
                                            ${STATUS_OPTIONS.map(s => `<option value="${s}" ${(apt.status||'Novo') === s ? 'selected' : ''}>${s}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Preço do Imóvel (R$) *</label>
                                        <input type="number" step="0.01" id="form-price" required value="${apt.price || ''}" placeholder="Ex: 350000" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Área Útil (m²) *</label>
                                        <input type="number" step="0.1" id="form-area" required value="${apt.area || ''}" placeholder="Ex: 75" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Número de Quartos *</label>
                                        <input type="number" id="form-bedrooms" required value="${apt.bedrooms || ''}" placeholder="Ex: 2" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Valor Condomínio (R$)</label>
                                        <input type="number" step="0.01" id="form-condo" value="${apt.condo || ''}" placeholder="Ex: 400" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">IPTU Anual (R$)</label>
                                        <input type="number" step="0.01" id="form-iptu" value="${apt.iptu || ''}" placeholder="Ex: 1200" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                    
                                    <!-- Novos Campos -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Andar</label>
                                        <input type="text" id="form-floor" value="${apt.floor || ''}" placeholder="Ex: 3º Andar, Térreo" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Orientação Solar</label>
                                        <select id="form-sunOrientation" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                            <option value="">Não Informado</option>
                                            <option value="Norte" ${(apt.sunOrientation==='Norte')?'selected':''}>Norte</option>
                                            <option value="Sul" ${(apt.sunOrientation==='Sul')?'selected':''}>Sul</option>
                                            <option value="Leste (Nascente)" ${(apt.sunOrientation==='Leste (Nascente)')?'selected':''}>Leste (Nascente)</option>
                                            <option value="Oeste (Poente)" ${(apt.sunOrientation==='Oeste (Poente)')?'selected':''}>Oeste (Poente)</option>
                                        </select>
                                    </div>

                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Link Original (URL) *</label>
                                        <input type="url" id="form-link" required value="${apt.link || ''}" placeholder="https://..." class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                </div>
                            </div>

                            <!-- SEÇÃO 2: LOCALIZAÇÃO -->
                            <div>
                                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2 text-lg"><i class="fa-solid fa-map-location-dot text-brand-500 mr-2"></i> Localização e Mídia</h3>
                                
                                <datalist id="cities-list">${[...new Set(this.state.apartments.map(a => a.city))].filter(Boolean).map(c => `<option value="${c}">`).join('')}</datalist>
                                <datalist id="neighborhoods-list">${[...new Set(this.state.apartments.map(a => a.neighborhood))].filter(Boolean).map(n => `<option value="${n}">`).join('')}</datalist>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Cidade *</label>
                                        <input type="text" list="cities-list" id="form-city" required value="${apt.city || ''}" placeholder="Ex: Blumenau" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Bairro *</label>
                                        <input type="text" list="neighborhoods-list" id="form-neighborhood" required value="${apt.neighborhood || ''}" placeholder="Ex: Victor Konder" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Endereço Completo (Ajuda no Mapa)</label>
                                        <input type="text" id="form-address" value="${apt.address || ''}" placeholder="Ex: Rua Antônio da Veiga, 100" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Nome do Edifício</label>
                                        <input type="text" id="form-building" value="${apt.building || ''}" placeholder="Ex: Residencial Bella Vista" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">URL da Foto Principal (Capa)</label>
                                        <input type="url" id="form-photo" value="${apt.photo || ''}" placeholder="https://.../foto.jpg" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                </div>
                            </div>

                            <!-- SEÇÃO 3: AVALIAÇÕES E INTEGRAÇÃO -->
                            <div class="bg-slate-50 p-4 md:p-5 rounded-xl border border-slate-200">
                                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-200 pb-2 text-lg"><i class="fa-solid fa-star-half-stroke text-amber-500 mr-2"></i> Suas Avaliações (1 a 5)</h3>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1"><i class="fa-solid fa-sack-dollar mr-1 text-slate-400"></i> Nota para Preço</label>
                                        <select id="form-rating-price" class="w-full bg-white border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none shadow-sm">
                                            ${[1,2,3,4,5].map(n => `<option value="${n}" ${(apt.ratingPrice||3) == n ? 'selected' : ''}>${n} Estrela${n>1?'s':''}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1"><i class="fa-solid fa-map-pin mr-1 text-slate-400"></i> Nota para Local</label>
                                        <select id="form-rating-location" class="w-full bg-white border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none shadow-sm">
                                            ${[1,2,3,4,5].map(n => `<option value="${n}" ${(apt.ratingLocation||3) == n ? 'selected' : ''}>${n} Estrela${n>1?'s':''}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1"><i class="fa-solid fa-couch mr-1 text-slate-400"></i> Nota p/ Decoração</label>
                                        <select id="form-rating-deco" class="w-full bg-white border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none shadow-sm">
                                            ${[1,2,3,4,5].map(n => `<option value="${n}" ${(apt.ratingDeco||3) == n ? 'selected' : ''}>${n} Estrela${n>1?'s':''}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Observações / Prós e Contras</label>
                                        <textarea id="form-notes" rows="3" class="w-full bg-white border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition" placeholder="Ex: Sol da manhã, aceita pet, precisa pintar...">${apt.notes || ''}</textarea>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 mb-1"><i class="fa-solid fa-user-tag text-brand-500 mr-1"></i> Cadastrado Por</label>
                                        <input type="text" id="form-addedBy" required value="${apt.addedBy || 'Você'}" placeholder="Seu nome" class="w-full md:w-1/2 bg-white border border-slate-300 text-slate-900 text-base md:text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 md:p-2.5 outline-none transition">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border-t border-slate-200 pt-6 mt-8 flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3">
                                <button type="button" onclick="app.navigate('list'); app.state.editingId = null;" class="text-slate-700 bg-white border border-slate-300 hover:bg-slate-50 focus:ring-4 focus:ring-slate-100 font-medium rounded-lg text-sm px-6 py-4 md:py-3 transition w-full sm:w-auto text-center">Cancelar</button>
                                <button type="submit" class="text-white bg-brand-600 hover:bg-brand-700 focus:ring-4 focus:ring-brand-300 font-medium rounded-lg text-sm px-6 py-4 md:py-3 transition flex items-center justify-center shadow-md w-full sm:w-auto">
                                    <i class="fa-solid fa-floppy-disk mr-2"></i> ${isEdit ? 'Salvar Alterações' : 'Cadastrar Apartamento'}
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                container.innerHTML = html;
            },

            async saveApartment() {
                const title = document.getElementById('form-title').value;
                const link = document.getElementById('form-link').value;
                const price = parseFloat(document.getElementById('form-price').value);
                const area = parseFloat(document.getElementById('form-area').value);
                const condo = parseFloat(document.getElementById('form-condo').value) || 0;
                const iptu = parseFloat(document.getElementById('form-iptu').value) || 0;
                const bedrooms = parseInt(document.getElementById('form-bedrooms').value);
                const photo = document.getElementById('form-photo').value;
                
                const floor = document.getElementById('form-floor').value;
                const sunOrientation = document.getElementById('form-sunOrientation').value;

                const city = document.getElementById('form-city').value;
                const neighborhood = document.getElementById('form-neighborhood').value;
                const address = document.getElementById('form-address').value;
                const building = document.getElementById('form-building').value;
                const notes = document.getElementById('form-notes').value;
                
                const status = document.getElementById('form-status').value;
                const ratingPrice = parseInt(document.getElementById('form-rating-price').value);
                const ratingLocation = parseInt(document.getElementById('form-rating-location').value);
                const ratingDeco = parseInt(document.getElementById('form-rating-deco').value);
                const addedBy = document.getElementById('form-addedBy').value || 'Você';

                const priceM2 = price / area;

                Swal.fire({ title: 'Salvando...', text: 'Verificando coordenadas e enviando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                let lat = null, lng = null;
                
                if (this.state.editingId) {
                    const existingApt = this.state.apartments.find(a => a.id === this.state.editingId);
                    if(existingApt && existingApt.lat) {
                        lat = existingApt.lat;
                        lng = existingApt.lng;
                    }
                }
                
                if (!lat) {
                    const geoQuery = address ? `${address}, ${city}, Brazil` : `${neighborhood}, ${city}, Brazil`;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(geoQuery)}`);
                        const data = await res.json();
                        if(data && data.length > 0) {
                            lat = parseFloat(data[0].lat);
                            lng = parseFloat(data[0].lon);
                        } else {
                            lat = -14.235; lng = -51.925;
                        }
                    } catch(e) {
                        lat = -14.235; lng = -51.925;
                    }
                }

                const aptData = {
                    title, link, price, area, condo, iptu, bedrooms, photo,
                    floor, sunOrientation, 
                    city, neighborhood, address, building, notes, priceM2, lat, lng,
                    ratingPrice, ratingLocation, ratingDeco, addedBy,
                    status,
                    dateAdded: new Date().toISOString()
                };

                try {
                    if (!supabaseClient) throw new Error("Supabase indisponível.");

                    if (this.state.editingId) {
                        aptData.id = this.state.editingId;
                        const { error } = await supabaseClient.from('apartments').update(aptData).eq('id', this.state.editingId);
                        if (error) throw error;

                        const index = this.state.apartments.findIndex(a => a.id === this.state.editingId);
                        if(index !== -1) {
                            aptData.favorite = this.state.apartments[index].favorite;
                            aptData.dateAdded = this.state.apartments[index].dateAdded;
                            this.state.apartments[index] = aptData;
                        }
                        this.state.editingId = null;
                        Swal.fire({icon: 'success', title: 'Atualizado!', text: 'Salvo com sucesso.', timer: 1500, showConfirmButton: false});
                    } else {
                        aptData.id = crypto.randomUUID(); 
                        aptData.favorite = false;
                        const { error } = await supabaseClient.from('apartments').insert([aptData]);
                        if (error) throw error;

                        this.state.apartments.unshift(aptData);
                        Swal.fire({icon: 'success', title: 'Cadastrado!', text: 'Imóvel salvo.', timer: 1500, showConfirmButton: false});
                    }
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    Swal.fire({icon: 'warning', title: 'Aviso', text: 'Salvo localmente (Offline).', timer: 2000, showConfirmButton: false});
                    if (this.state.editingId) {
                        aptData.id = this.state.editingId;
                        const index = this.state.apartments.findIndex(a => a.id === this.state.editingId);
                        if(index !== -1) {
                            aptData.favorite = this.state.apartments[index].favorite;
                            aptData.dateAdded = this.state.apartments[index].dateAdded;
                            this.state.apartments[index] = aptData;
                        }
                        this.state.editingId = null;
                    } else {
                        aptData.id = crypto.randomUUID(); 
                        aptData.favorite = false;
                        if (!aptData.status) aptData.status = 'Novo';
                        this.state.apartments.unshift(aptData);
                    }
                }

                localStorage.setItem('meuAptoIdealData_v2', JSON.stringify(this.state.apartments));
                this.navigate('list');
            },

            renderMap(container) {
                let centerLat = -15.7801, centerLng = -47.9292, zoom = 4;
                if (this.state.mapInstance) {
                    centerLat = this.state.mapInstance.getCenter().lat;
                    centerLng = this.state.mapInstance.getCenter().lng;
                    zoom = this.state.mapInstance.getZoom();
                } else if (this.state.apartments.length > 0) {
                    const validApt = this.state.apartments.find(a => a.lat && a.lat !== -14.235);
                    if (validApt) { centerLat = validApt.lat; centerLng = validApt.lng; zoom = 12; }
                }

                container.innerHTML = `
                    <div class="mb-4 ${this.state.draggingAptId ? 'hidden' : 'block'}">
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-800"><i class="fa-solid fa-map-location-dot text-brand-600 mr-2"></i> Mapa de Imóveis</h1>
                        <p class="text-slate-500 text-sm md:text-base mt-1">Clique num local para ver os imóveis cadastrados na região.</p>
                    </div>
                    
                    <div class="relative">
                        <div id="map" class="shadow-lg border border-slate-200"></div>
                        
                        ${this.state.draggingAptId ? `
                        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] w-11/12 max-w-sm bg-white/95 backdrop-blur rounded-2xl shadow-2xl border-2 border-brand-500 p-4 text-center animate-fade-in-up">
                            <div class="w-10 h-10 bg-brand-100 text-brand-600 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fa-solid fa-hand-holding-hand text-xl"></i></div>
                            <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">Ajuste o Local</h3>
                            <p class="text-xs text-slate-500 mb-4">Arraste o pino vermelho no mapa para a localização exata do imóvel.</p>
                            <div class="flex gap-2">
                                <button onclick="app.cancelDragging()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2.5 rounded-xl transition text-sm">Cancelar</button>
                                <button onclick="app.saveDraggedApt()" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white font-bold py-2.5 rounded-xl transition text-sm shadow-md">Salvar Local</button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                setTimeout(() => {
                    this.state.mapInstance = L.map('map', {zoomControl: false}).setView([centerLat, centerLng], zoom);
                    L.control.zoom({ position: 'bottomright' }).addTo(this.state.mapInstance);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(this.state.mapInstance);

                    if (this.state.draggingAptId) {
                        const apt = this.state.apartments.find(a => a.id === this.state.draggingAptId);
                        this.state.tempDragLatLng = L.latLng(apt.lat, apt.lng);
                        this.state.mapInstance.setView(this.state.tempDragLatLng, 16);

                        const dragIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div class="bg-red-500 text-white w-12 h-12 flex items-center justify-center rounded-full shadow-2xl border-4 border-white animate-bounce"><i class="fa-solid fa-location-dot text-xl"></i></div>`,
                            iconSize: [48, 48], iconAnchor: [24, 48]
                        });

                        const marker = L.marker([apt.lat, apt.lng], {icon: dragIcon, draggable: true}).addTo(this.state.mapInstance);
                        marker.on('dragend', (e) => { this.state.tempDragLatLng = e.target.getLatLng(); });
                        
                    } else {
                        let bounds = [];
                        const locationMap = {};
                        this.state.clusters = {}; 
                        let clusterCounter = 0;

                        this.state.apartments.forEach(apt => {
                            if (apt.lat && apt.lng) {
                                const key = `${parseFloat(apt.lat).toFixed(4)},${parseFloat(apt.lng).toFixed(4)}`;
                                if (!locationMap[key]) locationMap[key] = [];
                                locationMap[key].push(apt);
                            }
                        });

                        for (const key in locationMap) {
                            const apts = locationMap[key];
                            const lat = parseFloat(apts[0].lat);
                            const lng = parseFloat(apts[0].lng);
                            
                            const clusterId = 'cluster_' + clusterCounter++;
                            this.state.clusters[clusterId] = apts;

                            let iconHtml = `<div class="bg-brand-600 text-white w-8 h-8 flex items-center justify-center rounded-full shadow-lg border-2 border-white"><i class="fa-solid fa-house text-sm"></i></div>`;
                            if (apts.length > 1) {
                                iconHtml = `
                                <div class="relative bg-brand-700 text-white w-10 h-10 flex items-center justify-center rounded-full shadow-lg border-2 border-white">
                                    <i class="fa-solid fa-building text-base"></i>
                                    <div class="absolute -top-2 -right-2 bg-amber-500 text-white text-[11px] font-bold w-5 h-5 flex items-center justify-center rounded-full border border-white shadow-sm">${apts.length}</div>
                                </div>`;
                            }

                            const icon = L.divIcon({
                                className: 'custom-div-icon',
                                html: iconHtml,
                                iconSize: [apts.length > 1 ? 40 : 32, apts.length > 1 ? 40 : 32],
                                iconAnchor: [apts.length > 1 ? 20 : 16, apts.length > 1 ? 40 : 32],
                                popupAnchor: [0, apts.length > 1 ? -40 : -32]
                            });

                            const marker = L.marker([lat, lng], {icon: icon}).addTo(this.state.mapInstance);
                            const popupWrapper = `<div id="${clusterId}" class="w-full">${this.generateClusterInnerHTML(clusterId, 0)}</div>`;
                            marker.bindPopup(popupWrapper, { className: 'custom-leaflet-popup' });

                            bounds.push([lat, lng]);
                        }

                        if (bounds.length > 0) {
                            this.state.mapInstance.fitBounds(bounds, {padding: [50, 50]});
                        }
                    }
                }, 100);
            },

            generateClusterInnerHTML(clusterId, idx) {
                const apts = this.state.clusters[clusterId];
                if (!apts || !apts[idx]) return '';
                const apt = apts[idx];
                const avgRating = ((parseInt(apt.ratingPrice||3) + parseInt(apt.ratingLocation||3) + parseInt(apt.ratingDeco||3))/3).toFixed(1);
                
                const isDiscarded = apt.status === 'Descartado';
                const discardedStyles = isDiscarded ? 'opacity-50 grayscale hover:opacity-75 bg-slate-100' : 'bg-white';

                return `
                    <div class="w-full relative ${discardedStyles}">
                        <div class="h-32 w-full relative">
                            <img src="${apt.photo || 'https://via.placeholder.com/400x300'}" class="w-full h-full object-cover rounded-t-xl cursor-pointer" onclick="app.viewApt('${apt.id}')">
                            <div class="absolute top-2 left-2 px-1.5 py-0.5 rounded text-[9px] font-bold shadow border ${this.getStatusColor(apt.status)}">${apt.status || 'Novo'}</div>
                            <div class="absolute bottom-2 left-2 bg-brand-600 text-white px-2 py-1 rounded text-xs font-bold shadow">${this.formatCurrency(apt.price)}</div>
                            <div class="absolute bottom-2 right-2 bg-white/90 text-slate-800 px-2 py-1 rounded text-[10px] font-bold shadow"><i class="fa-solid fa-star text-amber-500"></i> ${avgRating}</div>
                        </div>
                        
                        <div class="p-3">
                            <h4 class="font-bold text-sm text-slate-800 leading-tight mb-1 truncate cursor-pointer hover:text-brand-600 transition" onclick="app.viewApt('${apt.id}')" title="${apt.title}">${apt.title}</h4>
                            <p class="text-[11px] text-slate-500 mb-3"><i class="fa-solid fa-bed"></i> ${apt.bedrooms} qtos | <i class="fa-solid fa-ruler"></i> ${apt.area}m²</p>
                            
                            <div class="flex gap-2 mb-2">
                                <button onclick="app.viewApt('${apt.id}')" class="flex-1 bg-brand-50 active:bg-brand-100 text-brand-700 text-xs font-bold py-2 rounded-lg transition border border-brand-100">Detalhes</button>
                                <button onclick="app.startDraggingApt('${apt.id}')" class="w-10 bg-slate-50 active:bg-slate-100 text-slate-600 flex items-center justify-center rounded-lg border border-slate-200" title="Ajustar Pino"><i class="fa-solid fa-up-down-left-right"></i></button>
                            </div>
                            
                            ${apts.length > 1 ? `
                            <div class="flex items-center justify-between border-t border-slate-100 pt-2 mt-1">
                                <button onclick="event.stopPropagation(); app.changeClusterPage('${clusterId}', ${idx - 1})" class="w-6 h-6 rounded-full bg-slate-100 active:bg-slate-200 flex items-center justify-center text-slate-600"><i class="fa-solid fa-chevron-left text-[10px]"></i></button>
                                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">${idx + 1} de ${apts.length}</span>
                                <button onclick="event.stopPropagation(); app.changeClusterPage('${clusterId}', ${idx + 1})" class="w-6 h-6 rounded-full bg-slate-100 active:bg-slate-200 flex items-center justify-center text-slate-600"><i class="fa-solid fa-chevron-right text-[10px]"></i></button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },

            changeClusterPage(clusterId, newIdx) {
                const apts = this.state.clusters[clusterId];
                if (!apts) return;
                
                if (newIdx < 0) newIdx = apts.length - 1;
                if (newIdx >= apts.length) newIdx = 0;
                
                const container = document.getElementById(clusterId);
                if (container) {
                    container.innerHTML = this.generateClusterInnerHTML(clusterId, newIdx);
                }
            },

            startDraggingApt(id) {
                this.closeModal(); 
                this.state.draggingAptId = id;
                this.navigate('map'); 
            },

            cancelDragging() {
                this.state.draggingAptId = null;
                this.state.tempDragLatLng = null;
                this.navigate('map'); 
            },

            async saveDraggedApt() {
                if(!this.state.tempDragLatLng) { this.cancelDragging(); return; }
                
                const id = this.state.draggingAptId;
                const apt = this.state.apartments.find(a => a.id === id);
                if(!apt) return;

                Swal.fire({ title: 'Atualizando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                const newLat = this.state.tempDragLatLng.lat;
                const newLng = this.state.tempDragLatLng.lng;

                apt.lat = newLat;
                apt.lng = newLng;

                try {
                    if (supabaseClient) {
                        await supabaseClient.from('apartments').update({lat: newLat, lng: newLng}).eq('id', id);
                    }
                } catch(e) { console.error("Erro Supabase", e); }

                localStorage.setItem('meuAptoIdealData_v2', JSON.stringify(this.state.apartments));
                
                Swal.fire({icon: 'success', title: 'Localização Salva!', timer: 1500, showConfirmButton: false});
                
                this.state.draggingAptId = null;
                this.state.tempDragLatLng = null;
                this.navigate('map');
            },

            // --- AI INTEGRATION ---
            async openAIModal() {
                const { value: text } = await Swal.fire({
                    title: '<i class="fa-solid fa-wand-magic-sparkles text-brand-600"></i> Extração com IA',
                    html: '<p class="text-sm text-slate-600 mb-2">Cole aqui abaixo todo o conteúdo que você copiou do anúncio.</p><textarea id="ai-text-input" class="w-full h-48 p-3 border border-slate-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 outline-none resize-none text-sm" placeholder="Ex: Apartamento no Bairro Centro em Timbó com 3 Dormitórios..."></textarea>',
                    showCancelButton: true, confirmButtonText: 'Extrair', cancelButtonText: 'Cancelar', confirmButtonColor: '#059669',
                    preConfirm: () => document.getElementById('ai-text-input').value || Swal.showValidationMessage('Cole algum texto.')
                });
                if (text) this.processWithAI(text);
            },

            async processWithAI(rawText) {
                Swal.fire({ title: 'Analisando com IA...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const apiKey = ""; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const prompt = `Analise o anúncio e extraia os dados.\nTexto:\n"""${rawText}"""`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: "Você é um corretor. Retorne um JSON. Se não achar, retorne nulo." }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                title: { type: "STRING" },
                                price: { type: "NUMBER" },
                                area: { type: "NUMBER" },
                                condo: { type: "NUMBER" },
                                iptu: { type: "NUMBER" },
                                bedrooms: { type: "NUMBER" },
                                city: { type: "STRING" },
                                neighborhood: { type: "STRING" },
                                address: { type: "STRING" },
                                building: { type: "STRING" },
                                floor: { type: "STRING", description: "O andar do apartamento (Ex: 3º Andar, Térreo)." },
                                sunOrientation: { type: "STRING", description: "Orientação solar (Nascente, Poente, Face Norte, Face Sul)." },
                                notes: { type: "STRING" }
                            }
                        }
                    }
                };

                for(let attempt=0; attempt<5; attempt++) {
                    try {
                        const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json();
                        const textData = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (textData) {
                            this.fillFormWithAI(JSON.parse(textData));
                            Swal.fire({ icon: 'success', title: 'Sucesso!', text: 'Extração concluída.', timer: 2000, showConfirmButton: false });
                            return;
                        }
                    } catch (e) {
                        if(attempt === 4) Swal.fire({ icon: 'error', title: 'Ops!', text: 'Erro na IA.' });
                        await new Promise(res => setTimeout(res, [1000, 2000, 4000, 8000, 16000][attempt]));
                    }
                }
            },

            fillFormWithAI(data) {
                if (data.title) document.getElementById('form-title').value = data.title;
                if (data.price !== undefined) document.getElementById('form-price').value = data.price;
                if (data.area !== undefined) document.getElementById('form-area').value = data.area;
                if (data.condo !== undefined) document.getElementById('form-condo').value = data.condo;
                if (data.iptu !== undefined) document.getElementById('form-iptu').value = data.iptu;
                if (data.bedrooms !== undefined) document.getElementById('form-bedrooms').value = data.bedrooms;
                if (data.city) document.getElementById('form-city').value = data.city;
                if (data.neighborhood) document.getElementById('form-neighborhood').value = data.neighborhood;
                if (data.address) document.getElementById('form-address').value = data.address;
                if (data.building) document.getElementById('form-building').value = data.building;
                if (data.floor) document.getElementById('form-floor').value = data.floor;
                if (data.sunOrientation) {
                    const sel = document.getElementById('form-sunOrientation');
                    const text = data.sunOrientation.toLowerCase();
                    if(text.includes('nasc') || text.includes('leste')) sel.value = 'Leste (Nascente)';
                    else if(text.includes('poen') || text.includes('oeste')) sel.value = 'Oeste (Poente)';
                    else if(text.includes('nort')) sel.value = 'Norte';
                    else if(text.includes('sul')) sel.value = 'Sul';
                }
                if (data.notes) document.getElementById('form-notes').value = data.notes;
            },

            getSampleData() {
                return [
                    {
                        id: "1", title: "Lindo Apto 2 quartos em Pinheiros", link: "https://exemplo.com", price: 650000, condo: 550, iptu: 120, city: "São Paulo", neighborhood: "Pinheiros", address: "Rua Teodoro Sampaio, 1000", photo: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80", bedrooms: 2, area: 65, priceM2: 10000, notes: "Bem localizado, perto do metrô. Precisa reformar a cozinha.", lat: -23.5645, lng: -46.6834, favorite: true, ratingPrice: 4, ratingLocation: 5, ratingDeco: 2, addedBy: "João Silva", status: "Visita Agendada", floor: "3º Andar", sunOrientation: "Norte", dateAdded: new Date(Date.now() - 86400000).toISOString()
                    },
                    {
                        id: "2", title: "Apartamento com Varanda Gourmet", link: "https://exemplo.com", price: 850000, condo: 800, iptu: 200, city: "São Paulo", neighborhood: "Vila Mariana", address: "Rua Domingos de Morais", photo: "https://images.unsplash.com/photo-1502672260266-1c1e5240980c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80", bedrooms: 3, area: 90, priceM2: 9444.44, notes: "Prédio novo com piscina e academia. Sol da tarde.", lat: -23.5891, lng: -46.6341, favorite: false, ratingPrice: 3, ratingLocation: 4, ratingDeco: 5, addedBy: "Maria Clara", status: "Novo", floor: "10º Andar", sunOrientation: "Oeste (Poente)", dateAdded: new Date().toISOString()
                    },
                    {
                        id: "3", title: "Kitnet mobiliada no Centro", link: "https://exemplo.com", price: 280000, condo: 300, iptu: 50, city: "São Paulo", neighborhood: "Centro Histórico", address: "Av. Ipiranga", photo: "https://images.unsplash.com/photo-1493809842364-78817add7ffb?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80", bedrooms: 1, area: 35, priceM2: 8000, notes: "Ótimo para investir e alugar. Sem garagem.", lat: -23.5432, lng: -46.6417, favorite: false, ratingPrice: 5, ratingLocation: 3, ratingDeco: 4, addedBy: "João Silva", status: "Descartado", floor: "1º Andar", sunOrientation: "Sul", dateAdded: new Date(Date.now() - 172800000).toISOString()
                    }
                ];
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
